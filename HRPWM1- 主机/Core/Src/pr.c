#include "main.h"
#include "pr.h"
#define PRTABLE_LENGTH 500 
float PRTable[PRTABLE_LENGTH] = {
0,12,25,37,50,62,75,87,100,112,125,137,150,162,175,187,
199,212,224,236,248,260,272,285,297,309,320,332,344,356,368,379,
391,402,414,425,437,448,459,470,481,492,503,514,525,535,546,556,
567,577,587,597,607,617,627,637,647,656,666,675,684,693,702,711,
720,728,737,745,754,762,770,778,786,793,801,809,816,823,830,837,
844,850,857,863,870,876,882,888,893,899,904,910,915,920,925,929,
934,938,942,947,951,954,958,962,965,968,971,974,977,979,982,984,
986,988,990,992,993,994,996,997,998,998,999,999,999,1000,999,999,
999,998,998,997,996,994,993,992,990,988,986,984,982,979,977,974,
971,968,965,962,958,954,951,947,942,938,934,929,925,920,915,910,
904,899,893,888,882,876,870,863,857,850,844,837,830,823,816,809,
801,793,786,778,770,762,754,745,737,728,720,711,702,693,684,675,
666,656,647,637,627,617,607,597,587,577,567,556,546,535,525,514,
503,492,481,470,459,448,437,425,414,402,391,379,368,356,344,332,
320,309,297,285,272,260,248,236,224,212,199,187,175,162,150,137,
125,112,100,87,75,62,50,37,25,12,0,-12,-25,-37,-50,-62,
-75,-87,-100,-112,-125,-137,-150,-162,-175,-187,-199,-212,-224,-236,-248,-260,
-272,-285,-297,-309,-320,-332,-344,-356,-368,-379,-391,-402,-414,-425,-437,-448,
-459,-470,-481,-492,-503,-514,-525,-535,-546,-556,-567,-577,-587,-597,-607,-617,
-627,-637,-647,-656,-666,-675,-684,-693,-702,-711,-720,-728,-737,-745,-754,-762,
-770,-778,-786,-793,-801,-809,-816,-823,-830,-837,-844,-850,-857,-863,-870,-876,
-882,-888,-893,-899,-904,-910,-915,-920,-925,-929,-934,-938,-942,-947,-951,-954,
-958,-962,-965,-968,-971,-974,-977,-979,-982,-984,-986,-988,-990,-992,-993,-994,
-996,-997,-998,-998,-999,-999,-999,-1000,-999,-999,-999,-998,-998,-997,-996,-994,
-993,-992,-990,-988,-986,-984,-982,-979,-977,-974,-971,-968,-965,-962,-958,-954,
-951,-947,-942,-938,-934,-929,-925,-920,-915,-910,-904,-899,-893,-888,-882,-876,
-870,-863,-857,-850,-844,-837,-830,-823,-816,-809,-801,-793,-786,-778,-770,-762,
-754,-745,-737,-728,-720,-711,-702,-693,-684,-675,-666,-656,-647,-637,-627,-617,
-607,-597,-587,-577,-567,-556,-546,-535,-525,-514,-503,-492,-481,-470,-459,-448,
-437,-425,-414,-402,-391,-379,-368,-356,-344,-332,-320,-309,-297,-285,-272,-260,
-248,-236,-224,-212,-199,-187,-175,-162,-150,-137,-125,-112,-100,-87,-75,-62,
-50,-37,-25,-12
};

//初始化控制器

void QPR_Init(QPRController *ctrl,float w0, float wc,float Ts,float Kr,float Kp)
{

ctrl->Kp = Kp;
ctrl->Kr = Kr;
ctrl->w0 = w0;
ctrl->wc = wc;
ctrl->Ts = Ts;

//计算中间变量

float a = 2.0f/ Ts;

float a_sq= a* a;

float w0_sq= w0 * w0;

float b0 = 2.0f* Kr * wc* a;

//计算分母系数

float a0=a_sq+2.0f*wc*a+w0_sq;
float a1 =-2.0f* a_sq + 2.0f * w0_sq; 
float a2=a_sq- 2.0f* wc* a + w0_sq;

//归一化系数

ctrl->b0_prime = b0/a0;
ctrl->b2_prime = -b0/a0;
ctrl->a1_prime  =a1/a0;
ctrl->a2_prime = a2/a0;


//初始化状态

ctrl->e_prev1 = 0.0f;

ctrl->e_prev2 = 0.0f;

ctrl->yr_prev1 = 0.0f; 

ctrl->yr_prev2 = 0.0f; 

}
//执行控制计算

float QPR_Update(QPRController *ctrl, float Reference, float FeedBack) {

 //计算当前误差

float e = Reference- FeedBack;

//计算谐振部分输出

float yr = ctrl->b0_prime * e+ ctrl->b2_prime * ctrl->e_prev2 - ctrl->a1_prime * ctrl->yr_prev1 - ctrl->a2_prime * ctrl->yr_prev2; 

//比例部分+谐振部分

float u = ctrl->Kp*e + yr;

//更新状态变量

ctrl->e_prev2 = ctrl->e_prev1;

ctrl->e_prev1 = e;

ctrl->yr_prev2 = ctrl->yr_prev1;

ctrl->yr_prev1 = yr;
return u;

}


















